---
title: "Ch2Blodgett_16S"
output: html_document
date: "2024-02-23"
---

```{r}
# LOAD PACKAGES
library(tidyverse)
library(vegan)
library(dplyr)
library(ggplot2)
library(DESeq2)
library(factoextra)
library(gridExtra)
library(cowplot)
library(ComplexUpset)

# Load RDS files
blodgett.asv <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/blodgett.asv.RDS")
tax_filtered <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/tax_filtered.RDS")
blodgett_map <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/blodgett_map.RDS")
```
# PCoA: ALL DATA (2021 + 2022) ... do this before taxonomy 
```{r}
# create rarefaction curve to determine rarefaction threshold for abundance table
# asv <- subset(blodgett.asv, select = -OTU_ID)
# don't need to run the below code every time, only the first time to figure out what to rarefy to
#asv.rarecurve <- rarecurve(t(asv), step = 100) 
#x <- map_dfr(asv.rarecurve, bind_rows) %>% bind_cols(colnames(asv),.)
#x <- as.data.frame(x)
#row.names(x) <- x[, 1]

#based on x dataframe, choose sample size to rarefy to
asv.rare <- t(rrarefy(t(blodgett.asv), sample = 18600))

# remove FIRE104 from abundance table (below rarefaction threshold)
asv.rare <- subset(asv.rare, select = -FIRE104)
# remove FIRE104 from blodgett_map
blodgett_map <- blodgett_map[blodgett_map$ID !="FIRE104",]
# remove singletons
asv.rare <- data.frame(asv.rare) %>%
  rmv_sngl()

#bray-curtis dissimilarity distance matrix 
asv.dist=vegdist(t(asv.rare), method = "bray")
asv.pcoa <- pcoa(asv.dist)
asv.pcoa.points <- pcoa.points(asv.pcoa)
asv.map <- pcoa.map(asv.pcoa.points, blodgett_map)
variance(asv.pcoa, 1)
variance(asv.pcoa, 2)

pcoa.plot.disturbance(asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "18.14% Variance Explained", y_label = "14.58% Variance Explained", title = "All Blodgett 16S rRNA ASV Profile", filename = "all_blodgett_ASV_pcoa_disturbance.pdf")
```

# Taxonomy Stacked Bar Plot: ALL DATA (2021 + 2022)
```{r}
# add OTU_ID back onto asv.rare
asv.rare$OTU_ID <- rownames(asv.rare)

# Join taxonomy and abundance data together
tax_blodgett <- left_join(asv.rare, tax_filtered, by = "OTU_ID")
# make sure asv.rare is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(asv.rare[[check_column]] == tax_blodgett[[check_column]])
unique(tax_blodgett$Phylum)

# pivot table and group by Phylum
tax_blodgett.long <- pivot_longer(tax_blodgett, cols=1:174, names_to = "ID", values_to = "counts")
blodgett.phylum.long <- group_by(tax_blodgett.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# collapse phyla into "other" category if represents less than 2%, which is 372 (rarefied to 18,600)
blodgett.phylum.long$Phylum <- as.character(blodgett.phylum.long$Phylum)
blodgett.phylum.long <- blodgett.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 372), 'Other', Phylum)) %>%
  ungroup()
# find out which phyla are represented (used for making legend)
unique(blodgett.phylum.long$NewPhylum)

# Prep data frame for plotting
blodgett.phylum.map <- merge(blodgett.phylum.long, blodgett_map, by="ID")
treatment_order <- c('Prescribed_Control','Heat_Field','Heat_Control', '30ºC', '60ºC', '90ºC', 'Prescribed_Burn')

# Plot
blodgett_phylum <- ggplot(blodgett.phylum.map, aes(x=factor(Treatment, level = treatment_order), y=counts, fill=NewPhylum))+
    labs(x="Treatment", 
       y ="Counts",
       title = "Blodgett 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  facet_wrap(~SampleType)

blodgett_phylum

blodgett_phylum <- ggsave("blodgett_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

# SUBSET DATA 
```{r}
asv.filtered <- subset(blodgett.asv, select = -FIRE104)
blodgett_filtered_map <- blodgett_map[blodgett_map$ID !="FIRE104", ]

identical(colnames(asv.filtered), blodgett_filtered_map$ID)

```
# Prescribed Burn Experiment Only
```{r}
p_map <- subset(blodgett_filtered_map, Treatment=="Prescribed_Burn" | blodgett_filtered_map$Treatment=="Prescribed_Control")
# Edit metadata 
p_map <- p_map %>% 
  mutate(TimePoint = case_when(
    Date == "4/5/2021" ~ "T1",
    Date == "4/18/2021" ~ "T2", 
    Date == "4/27/2021" ~ "T3", 
    Date == "5/8/2021" ~ "T4", 
    Date == "6/20/2021" ~ "T5")) %>%
  mutate(TimeSubPlot = paste(TimePoint, "-", SubPlot))
saveRDS(p_map, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/p_map.RDS")
p.asv <- asv.filtered[, blodgett_filtered_map$Treatment=="Prescribed_Burn" | blodgett_filtered_map$Treatment=="Prescribed_Control"] 

#check if samples are identical
identical(colnames(p.asv), p_map$ID)

# see how many ASVs from prescribed burn experiment by removing ASVs that are not detected at all
p.asv <- p.asv[rowSums(p.asv !=0) >0, ]

# don't need to run the below code every time, only the first time to figure out what to rarefy to
# p.asv.rarecurve <- rarecurve(t(p.asv), step = 100)
# x <- map_dfr(p.asv.rarecurve, bind_rows) %>% bind_cols(colnames(p.asv),.)
# x <- as.data.frame(x)
# row.names(x) <- x[, 1]

p.asv.rare <- t(rrarefy(t(p.asv), sample = 18500))
p.asv.rare <- data.frame(p.asv.rare) %>%
  rmv_sngl()

saveRDS(p.asv.rare, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/p.asv.rare.RDS")

```
# Everything except viromes
```{r}
t_map <- subset(blodgett_filtered_map, SampleType=="Total")
t.asv <- asv.filtered[, blodgett_filtered_map$SampleType=="Total"] 

identical(colnames(t.asv), t_map$ID)

# don't need to run the below code every time, only the first time to figure out what to rarefy to
# t.asv.rarecurve <- rarecurve(t(t.asv), step = 100)
# x <- map_dfr(t.asv.rarecurve, bind_rows) %>% bind_cols(colnames(t.asv),.)
# x <- as.data.frame(x)
# row.names(x) <- x[, 1]

t.asv.rare <- t(rrarefy(t(t.asv), sample = 18600))
t.asv.rare <- data.frame(t.asv.rare) %>%
  rmv_sngl()
```

## Subset depth 
# 0-3 cm (s - surface)
```{r}
s_map <- subset(p_map, Depth=="0-3cm")
s.asv <- p.asv[,p_map$Depth=="0-3cm"] %>%
  rmv_sngl()

#check if samples are identical
identical(colnames(s.asv), s_map$ID)

#s.asv.rarecurve <- rarecurve(t(s.asv), step = 100)
#x <- map_dfr(s.asv.rarecurve, bind_rows) %>% bind_cols(colnames(s.asv),.)
#x <- as.data.frame(x)
#row.names(x) <- x[, 1]

s.asv.rare <- t(rrarefy(t(s.asv), sample = 18200))
s.asv.rare <- data.frame(s.asv.rare) %>%
  rmv_sngl()
```
# 3-6 cm (d - deep)
```{r}
d_map <- subset(p_map, Depth=="3-6cm")
d.asv <- p.asv[,p_map$Depth=="3-6cm"] %>%
  rmv_sngl()

#check if samples are identical
identical(colnames(d.asv), d_map$ID)

#d.asv.rarecurve <- rarecurve(t(d.asv), step = 100)
#x <- map_dfr(d.asv.rarecurve, bind_rows) %>% bind_cols(colnames(d.asv),.)
#x <- as.data.frame(x)
#row.names(x) <- x[, 1]

d.asv.rare <- t(rrarefy(t(d.asv), sample = 20000))
d.asv.rare <- data.frame(d.asv.rare) %>%
  rmv_sngl()

```
## Subset Control Plots separate from Burn Plots
# control plots (c)
```{r}
c_map <- subset(p_map, Treatment=="Prescribed_Control")
c.asv <- p.asv[,p_map$Treatment=="Prescribed_Control"] %>%
  rmv_sngl()

#check if samples are identical
identical(colnames(c.asv), c_map$ID)

#c.asv.rarecurve <- rarecurve(t(c.asv), step = 100)
#x <- map_dfr(c.asv.rarecurve, bind_rows) %>% bind_cols(colnames(c.asv),.)
#x <- as.data.frame(x)
#row.names(x) <- x[, 1]

c.asv.rare <- t(rrarefy(t(c.asv), sample = 21700))
c.asv.rare <- data.frame(c.asv.rare) %>%
  rmv_sngl()
```
# burn plots (b)
```{r}
b.asv <- p.asv[,p_map$Treatment=="Prescribed_Burn"] %>%
  rmv_sngl()
b_map <- subset(p_map, Treatment=="Prescribed_Burn")

#check if samples are identical
identical(colnames(b.asv), b_map$ID)

# b.asv.rarecurve <- rarecurve(t(b.asv), step = 100)
# x <- map_dfr(b.asv.rarecurve, bind_rows) %>% bind_cols(colnames(b.asv),.)
# x <- as.data.frame(x)
# row.names(x) <- x[, 1]

b.asv.rare <- t(rrarefy(t(b.asv), sample = 18400))
b.asv.rare <- data.frame(b.asv.rare) %>%
  rmv_sngl()
```

# burn plots, disturbed samples only (bd)
```{r}
bd.asv <- p.asv[,p_map$Disturbance=="Yes_Burn"] %>%
  rmv_sngl()
bd_map <- subset(p_map, Disturbance=="Yes_Burn")
bd_map.pc1 = left_join(bd_map, pc1_asv, by="MapID")
bd_pc1.map = left_join(pc1_asv, bd_map, by="MapID")

#check if samples are identical
identical(colnames(bd.asv), bd_map$ID)

#bd.asv.rarecurve <- rarecurve(t(bd.asv), step = 100)
#x <- map_dfr(bd.asv.rarecurve, bind_rows) %>% bind_cols(colnames(bd.asv),.)
#x <- as.data.frame(x)
#row.names(x) <- x[, 1]

bd.asv.rare <- t(rrarefy(t(bd.asv), sample = 20100))
bd.asv.rare <- data.frame(bd.asv.rare) %>%
  rmv_sngl()
```

# NMDS
```{r}
b.asv.dist <- distance(b.asv.rare)

set.seed(1)
b.asv.nmds <- metaMDS(b.asv.dist)
b.asv.nmds$points

scores(b.asv.nmds) %>%
  as_tibble(rownames="ID") %>%
  inner_join(., b_map, by="ID") %>%
  ggplot(aes(x=NMDS1, y=NMDS2, color=Disturbance))+
  geom_point()+
  geom_text(aes(label= ID))+
  ggtitle("NMDS Plot of Disturbance in Treatment Plots, ASVs, Stress = 0.11")+
  theme_minimal()

bba.nut.mtx <- as.data.frame(bba.nut.mtx)
bba.nut.mtx <- rownames_to_column(bba.nut.mtx, var = "MapID")
bba.nut.mtx <- bba.nut.mtx %>%
  mutate(MapID = gsub("V", "M", MapID)) %>%
  mutate(MapID = ifelse(MapID == "UDM24D", "UDM24", MapID))
b.asv.env <- inner_join(b_map, bba.nut.mtx, by="MapID")
b.asv.fit <- envfit(b.asv.nmds, b.asv.env, permutations = 999)

nmds_scores <- scores(b.asv.nmds, display = "sites")
nmds_scores <- as_tibble(nmds_scores, rownames = "ID")
nmds_scores <- inner_join(nmds_scores, b.asv.env, by = "ID")

nmds_plot <- ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2, color = Disturbance)) +
  geom_point() +
  ggtitle("NMDS Plot of Disturbance in Treatment Plots, ASVs, Stress = 0.11") +
  xlab("NMDS1") +
  ylab("NMDS2") +
  theme_minimal()

vectors_df <- as.data.frame(b.asv.fit$vectors$arrows)
pvals <- b.asv.fit$vectors$pvals
vectors_df$pvals <- b.asv.fit$vectors$pvals
vectors_df$label <- rownames(vectors_df)
sig_vectors_df <- vectors_df %>% filter(pvals < 0.002)


nmds_plot +
  geom_segment(data = sig_vectors_df,
               aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.1, "cm")),
               color = "blue", alpha = 0.1) +
  geom_text(data = sig_vectors_df, 
            aes(x=NMDS1, y = NMDS2, label = label), 
            color = "blue",
            size = 3)
ggsave("b16S.nmds.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

# PCoA Plot
# Prescribed Burn Experiment Only
```{r}
#bray-curtis dissimilarity distance matrix 
p.asv.dist=vegdist(t(p.asv.rare), method = "bray")
p.asv.pcoa <- pcoa(p.asv.dist)
p.asv.pcoa.points <- pcoa.points(p.asv.pcoa)
p.asv.map <- pcoa.map(p.asv.pcoa.points, p_map)
variance(p.asv.pcoa, 1)
variance(p.asv.pcoa, 2)

pcoa.plot.p.disturbance(p.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "24.92% Variance Explained", y_label = "11.88% Variance Explained", title = "2021 Blodgett 16S rRNA ASV Profile", filename = "2021_blodgett_ASV_pcoa_disturbance.pdf")
pcoa.disturbance.cluster(p.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Cluster, shape_col = Disturbance, x_label = "24.92% Variance Explained", y_label = "11.88% Variance Explained", title = "2021 Blodgett 16S rRNA ASV Profile", filename = "2021_blodgett_ASV_pcoa_cluster.pdf")
pcoa.plot.plot.disturbance(p.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Plot, shape_col = Disturbance, x_label = "24.92% Variance Explained", y_label = "11.88% Variance Explained", title = "2021 Blodgett 16S rRNA ASV Profile", filename = "2021_blodgett_ASV_pcoa_plot_disturbance.pdf")


```
# 0-3 cm (s - surface)
```{r}
#bray-curtis dissimilarity distance matrix 
s.asv.dist=vegdist(t(s.asv.rare), method = "bray")
s.asv.pcoa <- pcoa(s.asv.dist)
s.asv.pcoa.points <- pcoa.points(s.asv.pcoa)
s.asv.map <- pcoa.map(s.asv.pcoa.points, s_map)
variance(s.asv.pcoa, 1)
variance(s.asv.pcoa, 2)

pcoa.plot.p.disturbance(s.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "26.71% Variance Explained", y_label = "13.20% Variance Explained", title = "0-3cm, 2021 Blodgett 16S rRNA ASV Profile", filename = "0-3cm_2021_blodgett_ASV_pcoa_disturbance.pdf")
```

# 3-6 cm (d - deep)
```{r}
#bray-curtis dissimilarity distance matrix 
d.asv.dist=vegdist(t(d.asv.rare), method = "bray")
d.asv.pcoa <- pcoa(d.asv.dist)
d.asv.pcoa.points <- pcoa.points(d.asv.pcoa)
d.asv.map <- pcoa.map(d.asv.pcoa.points, d_map)
variance(d.asv.pcoa, 1)
variance(d.asv.pcoa, 2)

pcoa.plot.p.disturbance(d.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "26.15% Variance Explained", y_label = "14.01% Variance Explained", title = "3-6cm, 2021 Blodgett 16S rRNA ASV Profile", filename = "3-6cm_2021_blodgett_ASV_pcoa_disturbance.pdf")
```

# control plots (c)
```{r}
#bray-curtis dissimilarity distance matrix 
c.asv.dist=vegdist(t(c.asv.rare), method = "bray")
c.asv.pcoa <- pcoa(c.asv.dist)
c.asv.pcoa.points <- pcoa.points(c.asv.pcoa)
c.asv.map <- pcoa.map(c.asv.pcoa.points, c_map)
variance(c.asv.pcoa, 1)
variance(c.asv.pcoa, 2)

pcoa.plot.p.disturbance(c.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "27.13% Variance Explained", y_label = "15.40% Variance Explained", title = "Control, 2021 Blodgett 16S rRNA ASV Profile", filename = "Control_2021_blodgett_ASV_pcoa_disturbance.pdf")
```

# burn plots (b)
```{r}
#bray-curtis dissimilarity distance matrix 
b.asv.dist=vegdist(t(b.asv.rare), method = "bray")
b.asv.pcoa <- pcoa(b.asv.dist)
b.asv.pcoa.points <- pcoa.points(b.asv.pcoa)
b.asv.map <- pcoa.map(b.asv.pcoa.points, b_map)
variance(b.asv.pcoa, 1)
variance(b.asv.pcoa, 2)

pcoa.plot.p.disturbance(b.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Disturbance, shape_col = Date, x_label = "27.55% Variance Explained", y_label = "14.20% Variance Explained", title = "Burn Plots, 2021 Blodgett 16S rRNA ASV Profile", filename = "Burn_2021_blodgett_ASV_pcoa_disturbance.pdf")
```

# burn plots, disturbed samples only (bd)
```{r}
#bray-curtis dissimilarity distance matrix 
bd.asv.dist=vegdist(t(bd.asv.rare), method = "bray")
bd.asv.pcoa <- pcoa(bd.asv.dist)
bd.asv.pcoa.points <- pcoa.points(bd.asv.pcoa)
bd.asv.map <- pcoa.map(bd.asv.pcoa.points, bd_map)
variance(bd.asv.pcoa, 1)
variance(bd.asv.pcoa, 2)

pcoa.plot.plot(bd.asv.map, x_col = pcoa1, y_col = pcoa2, color_col= Plot, shape_col = Date, x_label = "28.25% Variance Explained", y_label = "16.61% Variance Explained", title = "Burn Plots, Disturbed Samples, 2021 Blodgett 16S rRNA ASV Profile", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/pdf/PCoA/prokaryotes/BurnDisturbed_2021_blodgett_ASV_pcoa.pdf")

ggplot(bd.asv.map, aes(x=pcoa1, y=pcoa2, color=Plot))+
  geom_point(size = 3) +
  #scale_color_gradient(low = "yellow", high = "red") +
  labs(x = "28.25% Variance Explained", 
       y = "16.61% Variance Explained",
       title = "Burn Plots, Disturbed")+
  theme(axis.title = element_text(size = 16)) +
  theme(legend.text = element_text(size = 16), legend.position = "right") +
  theme(legend.title = element_text(size = 16)) +
  theme(axis.text = element_text(size = 16)) +
  theme(panel.background=element_rect(fill="white"), 
      panel.grid.major = element_line(color = "lightgrey"), 
      panel.grid.minor = element_line(color = "lightgrey"))

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/pdf/PCoA/prokaryotes/Burn_Disturbed_PCOA.pdf", width = 200, height = 125, units = "mm", dpi = 500)

pc1_asv <- pc1 %>%
  mutate(ID = gsub("V", "M", ID)) %>%
  mutate(ID = ifelse(ID == "UDM24D", "UDM24", ID))
colnames(pc1_asv)[colnames(pc1_asv) == "ID"] <- "MapID"

bd.asv.map.pc1 <- pcoa.map(bd.asv.pcoa.points, bd_map.pc1)

ggplot(bd.asv.map.pc1, aes(x=pcoa1, y=pcoa2, color=Comp.1))+
  geom_point(size = 3) +
  scale_color_gradient(low = "yellow", high = "red") +
  labs(x = "28.25% Variance Explained", 
       y = "16.61% Variance Explained",
       title = "Burn Plots, Disturbed Samples - ASV with PC1 gradient")+
  theme(axis.title = element_text(size = 16)) +
  theme(legend.text = element_text(size = 16), legend.position = "right") +
  theme(legend.title = element_text(size = 16)) +
  theme(axis.text = element_text(size = 16)) +
  theme(panel.background=element_rect(fill="white"), 
      panel.grid.major = element_line(color = "lightgrey"), 
      panel.grid.minor = element_line(color = "lightgrey"))

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/pdf/PCoA/prokaryotes/Burn_Disturbed_PC1_PCOA.pdf", width = 200, height = 125, units = "mm", dpi = 500)

Comp.1 <- bd_map.pc1$Comp.1
Comp.1.dist <- dist(Comp.1)

mantel_test <- mantel(bd.asv.dist, Comp.1.dist)
mantel_test

```

# Taxonomy Stacked Bar Chart
# Prescribed Burn Experiment Only
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
p.id.asv <- p.asv.rare
p.id.asv$OTU_ID <- rownames(p.id.asv)
tax_p <- left_join(p.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(p.id.asv[[check_column]] == tax_p[[check_column]])
unique(tax_p$Phylum)
# pivot table and group by Phylum
tax_p.long <- pivot_longer(tax_p, cols=1:114, names_to = "ID", values_to = "counts")
p.phylum.long <- group_by(tax_p.long, Phylum, ID) %>%
  dplyr::summarize(counts=sum(counts))

# rarefied to 18,500
# collapse phyla into "other" category if represents less than 2%, which is 370
p.phylum.long$Phylum <- as.character(p.phylum.long$Phylum)
p.phylum.long <- p.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 370), 'Other', Phylum)) %>%
  ungroup()

unique(p.phylum.long$NewPhylum)

saveRDS(p.phylum.long, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/rds/p.phylum.long.RDS")

# Prep data frame for plotting
p.phylum.map <- merge(p.phylum.long, p_map, by="ID")
# Arrange samples in correct timepoint order
p.phylum.map <- p.phylum.map %>%
  arrange(TimePoint)

# Plot (I believe this would summarize both depths into each subplot)
p_phylum <- ggplot(p.phylum.map, aes(x=TimeSubPlot, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "Prescribed Burn 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(12.5, 24.5, 36.5, 48.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
p_phylum
p_phylum <- ggsave("p_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)

# cluster plot
p.phylum.map <- p.phylum.map %>% 
  mutate(ClusterTime = paste(TimePoint, "-", SubPlot, "-", Cluster))

pk_phylum <- ggplot(p.phylum.map, aes(x=ClusterTime, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "Prescribed Burn 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(12.5, 24.5, 36.5, 48.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
pk_phylum <- ggsave("pk_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```
# Total DNA only
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
t.id.asv <- t.asv.rare
t.id.asv$OTU_ID <- rownames(t.id.asv)
tax_t <- left_join(t.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(t.id.asv[[check_column]] == tax_t[[check_column]])
unique(tax_t$Phylum)
# pivot table and group by Phylum
tax_t.long <- pivot_longer(tax_t, cols=1:144, names_to = "ID", values_to = "counts")
t.phylum.long <- group_by(tax_t.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# rarefied to 18,600
# collapse phyla into "other" category if represents less than 2%, which is 372
t.phylum.long$Phylum <- as.character(t.phylum.long$Phylum)
t.phylum.long <- t.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 372), 'Other', Phylum)) %>%
  ungroup()

unique(t.phylum.long$NewPhylum)

# Prep data frame for plotting
t.phylum.map <- merge(t.phylum.long, t_map, by="ID")
t.phylum.map <- t.phylum.map %>% 
  mutate(treatment = case_when(
    Date == "Prescribed_Control" ~ "T1",
    Date == "4/18/2021" ~ "T2", 
    Date == "4/27/2021" ~ "T3", 
    Date == "5/8/2021" ~ "T4")) %>%
  mutate(depth = case_when(
    Depth == "0-3cm" ~ " 0-3",
    Depth == "3-6cm" ~ " 3-6")) %>%
  arrange(Order) %>%
  mutate(SubPlotdepth = paste(SubPlot, depth)) %>%
  arrange(SubPlotdepth)
treatment_order <- c('Prescribed_Control','Heat_Field','Heat_Control', '30ºC', '60ºC', '90ºC', 'Prescribed_Burn')

# Plot
total_phylum <- ggplot(t.phylum.map, aes(x=factor(Treatment, level = treatment_order), y=counts, fill=NewPhylum))+
    labs(x="Treatment", 
       y ="Counts",
       title = "Blodgett 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

total_phylum <- ggsave("total_phylum.pdf", width = 200, height = 100, units = "mm", dpi = 500)

```


# 0-3 cm (s - surface)
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
s.id.asv <- s.asv.rare
s.id.asv$OTU_ID <- rownames(s.id.asv)
tax_s <- left_join(s.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(s.id.asv[[check_column]] == tax_s[[check_column]])
unique(tax_s$Phylum)
# pivot table and group by Phylum
tax_s.long <- pivot_longer(tax_s, cols=1:55, names_to = "ID", values_to = "counts")
s.phylum.long <- group_by(tax_s.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# rarefied to 18,200
# collapse phyla into "other" category if represents less than 2%, which is 364
s.phylum.long$Phylum <- as.character(s.phylum.long$Phylum)
s.phylum.long <- s.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 364), 'Other', Phylum)) %>%
  ungroup()

unique(s.phylum.long$NewPhylum)

# Prep data frame for plotting
s.phylum.map <- merge(s.phylum.long, s_map, by="ID")
# Arrange samples in correct timepoint order
s.phylum.map <- s.phylum.map %>%
  arrange(TimePoint)

# Plot 
s_phylum <- ggplot(s.phylum.map, aes(x=SubPlot, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Relative Abundance",
       title = "0-3cm, Prescribed Burn 16S rRNA ASV Profile")+
  annotate('rect', xmin = 8.5, xmax = 12.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none") +
  facet_wrap(~ TimePoint, ncol = 5)
s_phylum
s_phylum <- ggsave("s_phylum.pdf", width = 250, height = 80, units = "mm", dpi = 500)


# cluster plot
s.phylum.map <- s.phylum.map %>% 
  mutate(ClusterTime = paste(TimePoint, "-", SubPlot, "-", Cluster))

sk_phylum <- ggplot(s.phylum.map, aes(x=ClusterTime, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "0-3cm, Prescribed Burn 16S rRNA ASV Profile", fill = "Phylum")+
  annotate('rect', xmin = 7.5, xmax = 11.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 19.5, xmax = 23.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 31.5, xmax = 35.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 41.5, xmax = 44.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 51.5, xmax = Inf, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(11.5, 23.5, 35.5, 44.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
sk_phylum <- ggsave("sk_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```


# 3-6 cm (d - deep)
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
d.id.asv <- d.asv.rare
d.id.asv$OTU_ID <- rownames(d.id.asv)
tax_d <- left_join(d.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(d.id.asv[[check_column]] == tax_d[[check_column]])
unique(tax_d$Phylum)
# pivot table and group by Phylum
tax_d.long <- pivot_longer(tax_d, cols=1:59, names_to = "ID", values_to = "counts")
d.phylum.long <- group_by(tax_d.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# rarefied to 20000
# collapse phyla into "other" category if represents less than 2%, which is 400
d.phylum.long$Phylum <- as.character(d.phylum.long$Phylum)
d.phylum.long <- d.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 400), 'Other', Phylum)) %>%
  ungroup()

unique(d.phylum.long$NewPhylum)

# Prep data frame for plotting
d.phylum.map <- merge(d.phylum.long, d_map, by="ID")
# Arrange samples in correct timepoint order
d.phylum.map <- d.phylum.map %>%
  arrange(TimePoint)

# Plot
d_phylum <- ggplot(d.phylum.map, aes(x=SubPlot, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Relative Abundance",
       title = "3-6cm, Prescribed Burn 16S rRNA ASV Profile")+
  annotate('rect', xmin = 8.5, xmax = 12.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none") +
  facet_wrap(~ TimePoint, ncol = 5)
d_phylum
d_phylum <- ggsave("d_phylum.pdf", width = 250, height = 80, units = "mm", dpi = 500)

# cluster plot
d.phylum.map <- d.phylum.map %>% 
  mutate(ClusterTime = paste(TimePoint, "-", SubPlot, "-", Cluster))

dk_phylum <- ggplot(d.phylum.map, aes(x=ClusterTime, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "3-6cm, Prescribed Burn 16S rRNA ASV Profile", 
       fill = "Phylum")+
  annotate('rect', xmin = 8.5, xmax = 12.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 20.5, xmax = 24.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 32.5, xmax = 36.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 44.5, xmax = 48.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  annotate('rect', xmin = 56.5, xmax = Inf, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.75) +
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(12.5, 24.5, 36.5, 48.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
dk_phylum <- ggsave("dk_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```

# control plots (c)
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
c.id.asv <- c.asv.rare
c.id.asv$OTU_ID <- rownames(c.id.asv)
tax_c <- left_join(c.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(c.id.asv[[check_column]] == tax_c[[check_column]])
unique(tax_c$Phylum)
# pivot table and group by Phylum
tax_c.long <- pivot_longer(tax_c, cols=1:38, names_to = "ID", values_to = "counts")
c.phylum.long <- group_by(tax_c.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# rarefied to 21700
# collapse phyla into "other" category if represents less than 2%, which is 434
c.phylum.long$Phylum <- as.character(c.phylum.long$Phylum)
c.phylum.long <- c.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 434), 'Other', Phylum)) %>%
  ungroup()

unique(c.phylum.long$NewPhylum)

# Prep data frame for plotting
c.phylum.map <- merge(c.phylum.long, c_map, by="ID")
# Arrange samples in correct timepoint order
c.phylum.map <- c.phylum.map %>%
  arrange(TimePoint)

# Plot (I believe this would summarize both depths into each subplot)
c_phylum <- ggplot(c.phylum.map, aes(x=TimeSubPlot, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "Control Plots, Prescribed Burn 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(4.5, 8.5, 12.5, 16.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
c_phylum
c_phylum <- ggsave("c_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```
# burn plots (b)
```{r}
# Join taxonomy and abundance data together
# first, add OTU_ID back as a column
b.id.asv <- b.asv.rare
b.id.asv$OTU_ID <- rownames(b.id.asv)
tax_b <- left_join(b.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(b.id.asv[[check_column]] == tax_b[[check_column]])
unique(tax_b$Phylum)
# pivot table and group by Phylum
tax_b.long <- pivot_longer(tax_b, cols=1:76, names_to = "ID", values_to = "counts")
b.phylum.long <- group_by(tax_b.long, Phylum, ID) %>%
  summarize(counts=sum(counts))

# rarefied to 18400
# collapse phyla into "other" category if represents less than 2%, which is 368
b.phylum.long$Phylum <- as.character(b.phylum.long$Phylum)
b.phylum.long <- b.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 368), 'Other', Phylum)) %>%
  ungroup()

unique(b.phylum.long$NewPhylum)

# Prep data frame for plotting
b.phylum.map <- merge(b.phylum.long, b_map, by="ID")
# Arrange samples in correct timepoint order
b.phylum.map <- b.phylum.map %>%
  arrange(TimePoint)

# Plot (I believe this would summarize both depths into each subplot)
b_phylum <- ggplot(b.phylum.map, aes(x=TimeSubPlot, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "Burn Plots, Prescribed Burn 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  geom_vline(xintercept = c(8.5, 16.5, 24.5, 32.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "none")
b_phylum
b_phylum <- ggsave("b_phylum.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```
# burn plots, disturbed samples (bd)
```{r}
# Join taxonomy and abundance data together

# add in missing columns
mapping <- setNames(bd_map$MapID, bd_map$ID)
mapping
colnames(bd.asv.rare) <- mapping[colnames(bd.asv.rare)]
missing_columns <- setdiff(pc1_asv$MapID, colnames(bd.asv.rare))
missing_columns
bd.asv.rare.allsamples <- bd.asv.rare
for (col in missing_columns) {
  bd.asv.rare.allsamples[[col]] <- NA
}


# first, add OTU_ID back as a column
bd.id.asv <- bd.asv.rare.allsamples
bd.id.asv$OTU_ID <- rownames(bd.id.asv)
tax_bd <- left_join(bd.id.asv, tax_filtered, by = "OTU_ID")
# make sure blodgett.asv is in the same order as tax_blodgett (return = TRUE)
check_column <- "OTU_ID"
all(bd.id.asv[[check_column]] == tax_bd[[check_column]])
unique(tax_bd$Phylum)
# pivot table and group by Phylum
tax_bd.long <- pivot_longer(tax_bd, cols=1:48, names_to = "MapID", values_to = "counts")
bd.phylum.long <- group_by(tax_bd.long, Phylum, MapID) %>%
  dplyr::summarize(counts=sum(counts))

# rarefied to 20100
# collapse phyla into "other" category if represents less than 2%, which is 402
bd.phylum.long$Phylum <- as.character(bd.phylum.long$Phylum)
bd.phylum.long <- bd.phylum.long %>%
  group_by(Phylum) %>%
  mutate(NewPhylum = ifelse(all(counts < 402), 'Other', Phylum)) %>%
  ungroup()

unique(bd.phylum.long$NewPhylum)

# Prep data frame for plotting
bd.phylum.map <- merge(bd.phylum.long, bd_pc1.map, by="MapID")

# Arrange samples by Comp.1
bd.phylum.map <- bd.phylum.map %>%
  arrange(Comp.1) %>%
  mutate(rank = dense_rank(Comp.1))

# Plot (I believe this would be every single sample)
bd_phylum <- ggplot(bd.phylum.map, aes(x=rank, y=counts, fill=factor(NewPhylum, level=collapsed_phyla_order)))+
    labs(x="Sample", 
       y ="Counts",
       title = "Burn Plots, Disturbed Samples, PC1, 16S rRNA ASV Profile")+
  geom_bar(stat="identity", position = "fill", width = 0.75)+
  #geom_vline(xintercept = c(8.5, 16.5, 24.5, 32.5), linetype = "solid", color = "black", size = 0.75)+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(0.5,1.5,2.5,3.5,4.5,5.5,6.5,7.5,8.5,9.5,10.5,11.5,12.5,13.5,14.5,15.5,16.5,17.5,18.5,19.5,20.5,21.5,22.5,23.5,24.5,25.5,26.5,27.5,28.5,29.5,30.5,31.5,32.5,33.5,34.5,35.5,36.5,37.5,38.5,39.5,40.5, 41.5,42.5,43.5,44.5,45.5,46.5, 47.5, 48.5), linetype = "solid", color = "darkgray", linewidth = 0.15)+
  scale_x_continuous(limits = c(0.5,48.5), expand = c(0,0))+
  theme(
    panel.grid.major = element_blank(),  # Remove major grid lines
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.background = element_blank()
  ) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5),
        legend.position = "bottom")

bd_phylum
bd_phylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch2Blodgett/R_Figures/pdf/StackedBar/ASVPhylum/bd_phylum_PC1.pdf", width = 350, height = 100, units = "mm", dpi = 500)
```