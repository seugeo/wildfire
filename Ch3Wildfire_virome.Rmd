---
title: "Ch2Wildfire_virome"
output: html_document
date: "2024-06-18"
---

# LOAD PACKAGES
```{r}
library(tidyverse)
library(vegan)
library(lubridate)
library(dplyr)
library(ComplexUpset)
```
# Read Input Files
```{r}
# only read mapping within the LNU dataset (including the natural reserves sites from chaparral and woodland)
lnu_otu <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/lnu_otu.RDS")
# read mapping after clustering to everything (vOTUs originally found in PIGEON, vOTUs originally found in blodgett, and the LNU dataset)
lnu_Pb_otu <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/lnu_in_Pb_otu.RDS")
# abundance of vOTUs originally found in Blodgett
lnu_in_Blodgett_otu <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/lnu_in_blodgett_otu.RDS")
# abundance of vOTUs originally found in PIGEON
lnu_in_PIGEON_otu <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/lnu_in_PIGEON_otu.RDS")
# metadata
wildfire_data <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/wildfire_vOTU_map.RDS")

identical(colnames(lnu_otu), wildfire_data$ViromeID)
```

# DNA Yields
```{r}
wildfire_DNA <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/wildfire_DNA.RDS")

wildfire_DNA <- wildfire_DNA %>%
  mutate(Time_Days = paste(TimePoint, "/", DaysAfterFire))


# replacing NA with "0" - the bottom of threshold
DNA_NA_0 <- wildfire_DNA
DNA_NA_0$DNA_g[is.na(DNA_NA_0$DNA_g)] <- 0
ggplot(DNA_NA_0, aes(x = Time_Days, y = DNA_g, fill = Treatment)) +
  geom_boxplot(width = 0.5, outlier.shape=NA, position = position_dodge(width = 0.75)) +
  geom_jitter(aes(color = Habitat), position = position_jitter(width = 0.05), size = 1.5) +
  xlab("Timepoint / Days Since Fire") +
  ylab("DNA yield (ng/g soil)") +
  theme_bw() +
  theme(axis.title = element_text(size = 16)) +
  theme(legend.position = "right", legend.text = element_text(size=16), legend.title = element_text(size=16)) +
  theme(axis.text = element_text(size = 16)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = Habitat_Color) +
  scale_fill_manual(values = Treatment_20_Color, limits = Treatment_20_Order) +
  facet_wrap(~ Treatment)

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/BoxPlot/LNU_DNA_NA_0.pdf", width = 200, height = 100, units = "mm", dpi = 500)

# stats on DNA yield 
# this is where the NA values are replaced with a 0
DNA_NA_0.stats <- DNA_NA_0
DNA_NA_0_c_ctrl <- DNA_NA_0.stats %>%
  filter(Habitat == "Chaparral"&Treatment == "Control")
kruskal.test(DNA ~ TimePoint, DNA_NA_0_c_ctrl)
DNA_NA_0_c_burn <- DNA_NA_0.stats %>%
  filter(Habitat == "Chaparral"&Treatment == "Burn")
kruskal.test(DNA ~ TimePoint, DNA_NA_0_c_burn)
DNA_NA_0_w_ctrl <- DNA_NA_0.stats %>%
  filter(Habitat == "Woodland"&Treatment == "Control")
kruskal.test(DNA ~ TimePoint, DNA_NA_0_w_ctrl)
DNA_NA_0_w_burn <- DNA_NA_0.stats %>%
  filter(Habitat == "Woodland"&Treatment == "Burn")
kruskal.test(DNA ~ TimePoint, DNA_NA_0_w_burn)
DNA_NA_0_T3 <- DNA_NA_0.stats %>%
  filter(TimePoint == "T3")
kruskal.test(DNA ~ Treatment, DNA_NA_0_T3)
DNA_NA_0_T4 <- DNA_NA_0.stats %>%
  filter(TimePoint == "T4")
kruskal.test(DNA ~ Treatment, DNA_NA_0_T4)
DNA_NA_0_T5 <- DNA_NA_0.stats %>%
  filter(TimePoint == "T5")
kruskal.test(DNA ~ Treatment, DNA_NA_0_T5)

# replacing NA with "0.49" - the top of threshold
DNA_NA_0.49 <- wildfire_DNA
DNA_NA_0.49[is.na(DNA_NA_0.49)] <- 0.49
ggplot(DNA_NA_0.49, aes(x = TimePoint, y = DNA, fill = Treatment)) +
  geom_boxplot(width = 0.5, outlier.shape=NA, position = position_dodge(width = 0.75)) +
  geom_jitter(aes(color = Habitat), position = position_jitter(width = 0.05), size = 1.5) +
  xlab("Timepoint / Days Since Fire") +
  ylab("DNA Yield (ng)") +
  theme_bw() +
  theme(axis.title = element_text(size = 16)) +
  theme(legend.position = "bottom", legend.text = element_text(size=16), legend.title = element_text(size=16)) +
  theme(axis.text = element_text(size = 16)) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_color_manual(values = Habitat_Color) +
  scale_fill_manual(values = Treatment_20_Color) +
  facet_wrap(~ Treatment)

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/BoxPlot/LNU_DNA_NA_0.49.pdf", width = 200, height = 120, units = "mm", dpi = 500)

# stats on DNA yield 
# this is where the NA values are replaced with a 0.49
DNA_NA_0.49.stats <- DNA_NA_0.49
DNA_NA_0.49_c_ctrl <- DNA_NA_0.49.stats %>%
  filter(Habitat == "Chaparral"&Treatment == "Control")
kruskal.test(DNA ~ TimePoint, DNA_NA_0.49_c_ctrl)
DNA_NA_0.49_c_burn <- DNA_NA_0.49.stats %>%
  filter(Habitat == "Chaparral"&Treatment == "Burn")
kruskal.test(DNA ~ TimePoint, DNA_NA_0.49_c_burn)
DNA_NA_0.49_w_ctrl <- DNA_NA_0.49.stats %>%
  filter(Habitat == "Woodland"&Treatment == "Control")
kruskal.test(DNA ~ TimePoint, DNA_NA_0.49_w_ctrl)
DNA_NA_0.49_w_burn <- DNA_NA_0.49.stats %>%
  filter(Habitat == "Woodland"&Treatment == "Burn")
kruskal.test(DNA ~ TimePoint, DNA_NA_0.49_w_burn)
```

# PCoA of Entire Dataset
```{r}
dfname <- "lnu_Pb_otu"
df <- get(dfname)
otu <- rmv_sngl(df)
otu.rel <- relativize(otu)
colSums(otu.rel)

otu.dist <- distance(otu.rel)
otu.pcoa <- pcoa(otu.dist)
otu.pcoa.points <- pcoa.points(otu.pcoa)
otu.map <- pcoa.map(otu.pcoa.points, wildfire_data)
variance(otu.pcoa, 1)
variance(otu.pcoa, 2)

# Treatment + Habitat
pcoa.treatment.habitat(otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Treatment, shape_col = Habitat, x_label = "PCo1 (10.24% Variance Explained)", y_label = "PCo2 (6.61% Variance Explained)", title = "LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/lnu_Pb_otu_treatment_habitat.pdf")

ggplot(otu.map, aes(x=pcoa1, y=pcoa2, color=Treatment, shape = Habitat))+
  geom_point(size = 3) +
  labs(x = "PCo1 (10.24% Variance Explained)", 
       y = "PCo2 (6.61% Variance Explained)",
       title = "All LNU Viromes")+
  theme(axis.title = element_text(size = 18)) +
  theme(legend.text = element_text(size = 18), legend.position = "right") +
  theme(legend.title = element_text(size = 18)) +
  theme(axis.text = element_text(size = 18)) +
  scale_color_manual(values=Treatment_Color, limits=Treatment_Order) +
  theme(panel.background=element_rect(fill="white"), 
      panel.grid.major = element_line(color = "lightgrey"), 
      panel.grid.minor = element_line(color = "lightgrey"))

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/lnu_Pb_otu_treatment_habitat.pdf", width = 200, height = 125, units = "mm", dpi = 500)

# run PERMANOVAs
variables <- c("Habitat", "Treatment", "Location")
adonis.results <- run_adonis(variables, otu.dist, otu.map)
adonis.table <- do.call(rbind, adonis.results)
```
# PCoA of LNU Entire Dataset (not clustered with PIGEON/blodgett)
```{r}
dfname <- "lnu_otu"
df <- get(dfname)
otu <- rmv_sngl(df)
otu.rel <- relativize(otu)
colSums(otu.rel)

otu.dist <- distance(otu.rel)
otu.pcoa <- pcoa(otu.dist)
otu.pcoa.points <- pcoa.points(otu.pcoa)
otu.map <- pcoa.map(otu.pcoa.points, wildfire_data)
variance(otu.pcoa, 1)
variance(otu.pcoa, 2)

# Treatment + Habitat
pcoa.treatment.habitat(otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Treatment, shape_col = Habitat, x_label = "9.91% Variance Explained", y_label = "6.55% Variance Explained", title = "LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/lnu_otu_treatment_habitat.pdf")

pcoa.habitat.location(otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Habitat, shape_col = Location, x_label = "9.91% Variance Explained", y_label = "6.55% Variance Explained", title = "LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/lnu_Pb_otu_habitat_location.pdf")

# run PERMANOVAs
variables <- c("Habitat", "Treatment", "Location")
adonis.results <- run_adonis(variables, otu.dist, otu.map)
adonis.table <- do.call(rbind, adonis.results)
```
# SUBSET DATA: Abundance(Remove Singletons & Relativize), Metadata, & Count)
# Remove 2019 Samples (pf = post fire)
```{r}
pf.otu <- lnu_Pb_otu[, wildfire_data$Date!="11/1/2019"] %>%
  rmv_sngl()
pf.otu.rel <- relativize(pf.otu)
colSums(pf.otu.rel)
pf.map <- subset(wildfire_data, Date!="11/1/2019")
richness <- colSums(pf.otu.rel > 0)
pf.map$Richness <- richness
```
# Only keep samples that were burned (b = burned)
```{r}
b.otu <- lnu_Pb_otu[, wildfire_data$Treatment=="AfterBurn_Wildfire"] %>%
  rmv_sngl()
b.otu.rel <- relativize(b.otu)
colSums(b.otu.rel)
b.map <- subset(wildfire_data, Treatment=="AfterBurn_Wildfire")
richness <- colSums(b.otu.rel > 0)
b.map$Richness <- richness

identical(colnames(b.otu.rel), b.map$ViromeID)
```
# Chaparral only (ch - chaparral) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
ch.otu <- lnu_otu[, wildfire_data$Habitat=="Chaparral"] %>%
  rmv_sngl()
ch.otu.rel <- relativize(ch.otu)
colSums(ch.otu.rel)
ch.map <- subset(wildfire_data, Habitat=="Chaparral")
richness <- colSums(ch.otu.rel > 0)
ch.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(ch.otu.rel), ch.map$ViromeID)
```
# Chaparral, burned only (f.ch - fire, chaparral) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
f.ch.otu <- lnu_otu[, wildfire_data$Habitat=="Chaparral" & wildfire_data$Treatment=="AfterBurn_Wildfire"] %>%
  rmv_sngl()
f.ch.otu.rel <- relativize(f.ch.otu)
colSums(f.ch.otu.rel)
f.ch.map <- subset(wildfire_data, Habitat=="Chaparral" & wildfire_data$Treatment=="AfterBurn_Wildfire")
richness <- colSums(f.ch.otu.rel > 0)
f.ch.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(f.ch.otu.rel), f.ch.map$ViromeID)
```
# Chaparral, T3 only (T3.ch - T3, chaparral) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
T3.ch.otu <- lnu_otu[, wildfire_data$Habitat=="Chaparral" & wildfire_data$TimePoint=="T3"] %>%
  rmv_sngl()
T3.ch.otu.rel <- relativize(T3.ch.otu)
colSums(T3.ch.otu.rel)
T3.ch.map <- subset(wildfire_data, Habitat=="Chaparral" & wildfire_data$TimePoint=="T3")
richness <- colSums(T3.ch.otu.rel > 0)
T3.ch.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(T3.ch.otu.rel), T3.ch.map$ViromeID)
```
# Woodland only (wo - woodland) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
wo.otu <- lnu_otu[, wildfire_data$Habitat=="Woodland"] %>%
  rmv_sngl()
wo.otu.rel <- relativize(wo.otu)
colSums(wo.otu.rel)
wo.map <- subset(wildfire_data, Habitat=="Woodland")
richness <- colSums(wo.otu.rel > 0)
wo.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(wo.otu.rel), wo.map$ViromeID)
```
# Woodland, burned only (f.wo - fire, woodland) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
f.wo.otu <- lnu_otu[, wildfire_data$Habitat=="Woodland" & wildfire_data$Treatment=="AfterBurn_Wildfire"] %>%
  rmv_sngl()
f.wo.otu.rel <- relativize(f.wo.otu)
colSums(f.wo.otu.rel)
f.wo.map <- subset(wildfire_data, Habitat=="Woodland" & wildfire_data$Treatment=="AfterBurn_Wildfire")
richness <- colSums(f.wo.otu.rel > 0)
f.wo.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(f.wo.otu.rel), f.wo.map$ViromeID)
```
# Woodland, T3 only (T3.wo - T3, Woodland) and only with LNU clustered dataset (not clustered with PIGEON or blodgett)
```{r}
T3.wo.otu <- lnu_otu[, wildfire_data$Habitat=="Woodland" & wildfire_data$TimePoint=="T3"] %>%
  rmv_sngl()
T3.wo.otu.rel <- relativize(T3.wo.otu)
colSums(T3.wo.otu.rel)
T3.wo.map <- subset(wildfire_data, Habitat=="Woodland" & wildfire_data$TimePoint=="T3")
richness <- colSums(T3.wo.otu.rel > 0)
T3.wo.map$Richness <- richness

# make sure IDs are identical in abundance and metadata tables
identical(colnames(T3.wo.otu.rel), T3.wo.map$ViromeID)
```
# PCoA of Subset Samples
# PCoA of Post Fire Samples (pf)
```{r}
pf.otu.dist <- distance(pf.otu.rel)
saveRDS(pf.otu.dist, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/pf.otu.dist.RDS")
pf.otu.pcoa <- pcoa(pf.otu.dist)
pf.otu.pcoa.points <- pcoa.points(pf.otu.pcoa)
pf.otu.map <- pcoa.map(pf.otu.pcoa.points, pf.map)
variance(pf.otu.pcoa, 1)
variance(pf.otu.pcoa, 2)
pcoa.treatment.habitat(pf.otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Treatment, shape_col = Habitat, x_label = "11.62% Variance Explained", y_label = "7.98% Variance Explained", title = "Post-Fire LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/pf_lnu_Pb_otu_treatment_habitat.pdf")
pcoa.treatment.location(pf.otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Treatment, shape_col = Location, x_label = "11.62% Variance Explained", y_label = "7.98% Variance Explained", title = "Post-Fire LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/pf_lnu_Pb_otu_treatment_location.pdf")
# run PERMANOVAs
variables <- c("Habitat", "Treatment", "Location")
pf.adonis.results <- run_adonis(variables, pf.otu.dist, pf.otu.map)
pf.adonis.table <- do.call(rbind, pf.adonis.results)
```
# PCoA of Burned Samples Only (b)
```{r}
b.otu.dist <- distance(b.otu.rel)
b.otu.pcoa <- pcoa(b.otu.dist)
b.otu.pcoa.points <- pcoa.points(b.otu.pcoa)
b.otu.map <- pcoa.map(b.otu.pcoa.points, b.map)
variance(b.otu.pcoa, 1)
variance(b.otu.pcoa, 2)
pcoa.habitat.location(b.otu.map, x_col = pcoa1, y_col = pcoa2, color_col= Habitat, shape_col = Location, x_label = "12.65% Variance Explained", y_label = "9.27% Variance Explained", title = "Post-Fire, Burned LNU Viromes", filename = "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/PCoA/viromes/b_lnu_Pb_otu_habitat_location.pdf")
# run PERMANOVAs
variables <- c("Habitat", "Location")
b.adonis.results <- run_adonis(variables, b.otu.dist, b.otu.map)
b.adonis.table <- do.call(rbind, b.adonis.results)
```
# NMDS of Post Fire Samples (pf)
```{r}
pf.otu.dist <- distance(pf.otu.rel)

set.seed(1)
pf.nmds <- metaMDS(pf.otu.dist)
pf.nmds$points
plot(pf.nmds)

scores(pf.nmds) %>%
  as_tibble(rownames="ViromeID") %>%
  inner_join(., pf.map, by="ViromeID") %>%
  ggplot(aes(x=NMDS1, y=NMDS2, shape=Habitat))+
  geom_point()+
  geom_text(aes(label= ViromeID))+
  ggtitle("NMDS Plot of Habitat in Post-Fire Plots, Stress = 0.12")+
  theme_minimal()

pf.nut.mtx <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/w.nut.mtx.RDS")

pf.nut.mtx <- as.data.frame(pf.nut.mtx)
pf.nut.mtx <- rownames_to_column(pf.nut.mtx, var = "ViromeID")
pf.metadata <- select(pf.map, -Richness, -Moisture, -DNA)
  
pf.env <- inner_join(pf.metadata, pf.nut.mtx, by="ViromeID")
pf.fit <- envfit(pf.nmds, pf.env, permutations = 999)

nmds_scores <- scores(pf.nmds, display = "sites")
nmds_scores <- as_tibble(nmds_scores, rownames = "ViromeID")
nmds_scores <- inner_join(nmds_scores, pf.env, by = "ViromeID")

nmds_plot <- ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2, color = Treatment, shape = Habitat)) +
  geom_point(size=3) +
  #ggtitle("NMDS Plot of Habitat in Post-Fire Plots, Stress = 0.12") +
  xlab("NMDS1") +
  ylab("NMDS2") +
  scale_color_manual(values = pf_treatment_color, limits = pf_treatment_order)+
  theme_minimal()+
  theme(axis.title.x = element_text(size = 15), 
    axis.title.y = element_text(size = 15), 
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )

ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/NMDS/pf.nmds.pdf", width = 200, height = 150, units = "mm", dpi = 500)


vectors_df <- as.data.frame(pf.fit$vectors$arrows)
pvals <- pf.fit$vectors$pvals
vectors_df$pvals <- pf.fit$vectors$pvals
vectors_df$label <- rownames(vectors_df)
sig_vectors_df <- vectors_df %>% filter(pvals < 0.05)

scale_factor <- 0.5
sig_vectors_df <- sig_vectors_df %>%
  mutate(scaled_NMDS1 = NMDS1 * scale_factor,
         scaled_NMDS2 = NMDS2 * scale_factor)

x <- ggplot()+
  theme(panel.grid.major = element_blank(),   # Remove major grid lines
        panel.grid.minor = element_blank()) 
x +
  geom_segment(data = sig_vectors_df,
               aes(x = 0, y = 0, xend = scaled_NMDS1, yend = scaled_NMDS2),
               arrow = arrow(length = unit(0.1, "cm")),
               color = "black", alpha = 0.2, inherit.aes = FALSE) +
  geom_text(data = sig_vectors_df, 
            aes(x=NMDS1, y = NMDS2, label = label), 
            color = "black",
            size = 3, inherit.aes = FALSE)
ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/NMDS/pf.nmds.vectors.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```
# NMDS of Burned Samples (b)
```{r}
b.otu.dist <- distance(b.otu.rel)

set.seed(1)
b.nmds <- metaMDS(b.otu.dist)
b.nmds$points
plot(b.nmds)

scores(b.nmds) %>%
  as_tibble(rownames="ViromeID") %>%
  inner_join(., b.map, by="ViromeID") %>%
  ggplot(aes(x=NMDS1, y=NMDS2, shape=Habitat))+
  geom_point()+
  geom_text(aes(label= ViromeID))+
  ggtitle("NMDS Plot of Habitat in Burned Plots, Stress = 0.14")+
  theme_minimal()

b.nut.mtx <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/w.nut.mtx.RDS")

b.nut.mtx <- as.data.frame(b.nut.mtx)
b.nut.mtx <- rownames_to_column(b.nut.mtx, var = "ViromeID")
b.metadata <- select(b.map, -Richness, -Moisture, -DNA)
  
b.env <- inner_join(b.metadata, b.nut.mtx, by="ViromeID")
b.fit <- envfit(b.nmds, b.env, permutations = 999)

nmds_scores <- scores(b.nmds, display = "sites")
nmds_scores <- as_tibble(nmds_scores, rownames = "ViromeID")
nmds_scores <- inner_join(nmds_scores, b.env, by = "ViromeID")

nmds_plot <- ggplot(nmds_scores, aes(x = NMDS1, y = NMDS2, color = Habitat, shape = Treatment)) +
  geom_point(size=3) +
  ggtitle("NMDS Plot of Habitat in Burned Plots, Stress = 0.14") +
  xlab("NMDS1") +
  ylab("NMDS2") +
  scale_color_manual(values = Habitat_Color)+
  theme_minimal() +
  theme(axis.title.x = element_text(size = 15), 
    axis.title.y = element_text(size = 15), 
    axis.text.x = element_text(size = 12),
    axis.text.y = element_text(size = 12)
  )

vectors_df <- as.data.frame(b.fit$vectors$arrows)
pvals <- b.fit$vectors$pvals
vectors_df$pvals <- b.fit$vectors$pvals
vectors_df$label <- rownames(vectors_df)
sig_vectors_df <- vectors_df %>% filter(pvals < 0.05)

nmds_plot +
  geom_segment(data = sig_vectors_df,
               aes(x = 0, y = 0, xend = NMDS1, yend = NMDS2),
               arrow = arrow(length = unit(0.2, "cm")),
               color = "black", alpha = 0.2, inherit.aes = FALSE) +
  geom_text(data = sig_vectors_df, 
            aes(x=NMDS1, y = NMDS2, label = label), 
            color = "black",
            size = 4, inherit.aes = FALSE)
ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/NMDS/b.nmds.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

# Upset Plot of All Samples
```{r}
# Habitat
map <- wildfire_data
cbbmap <- map %>%
  filter(Date=="11/1/2019"&Habitat=="Chaparral")
wbbmap <- map %>%
  filter(Date=="11/1/2019"&Habitat=="Woodland")
cabmap <- map %>%
  filter(Treatment=="AfterBurn_Wildfire"&Habitat=="Chaparral")
wabmap <- map %>%
  filter(Treatment=="AfterBurn_Wildfire"&Habitat=="Woodland")
cacmap <- map %>%
  filter(Treatment=="AfterBurn_Control"&Habitat=="Chaparral")
wacmap <- map %>%
  filter(Treatment=="AfterBurn_Control"&Habitat=="Woodland")

upset <- otu.rel
Chaparral_BeforeBurn <- upset[,colnames(upset)%in%cbbmap$ViromeID]
Woodland_BeforeBurn <- upset[,colnames(upset)%in%wbbmap$ViromeID]
Chaparral_AfterBurn <- upset[,colnames(upset)%in%cabmap$ViromeID]
Woodland_AfterBurn <- upset[,colnames(upset)%in%wabmap$ViromeID]
Chaparral_AfterControl <- upset[,colnames(upset)%in%cacmap$ViromeID]
Woodland_AfterControl <- upset[,colnames(upset)%in%wacmap$ViromeID]

Chaparral_BeforeBurn_pa <- rowSums(Chaparral_BeforeBurn)>0  
Woodland_BeforeBurn_pa <- rowSums(Woodland_BeforeBurn) >0
Chaparral_AfterBurn_pa <- rowSums(Chaparral_AfterBurn)>0  
Woodland_AfterBurn_pa <- rowSums(Woodland_AfterBurn) >0
Chaparral_AfterControl_pa <- rowSums(Chaparral_AfterControl)>0  
Woodland_AfterControl_pa <- rowSums(Woodland_AfterControl) >0

upsetdata <- data.frame(Chaparral_BeforeBurn=Chaparral_BeforeBurn_pa, Woodland_BeforeBurn=Woodland_BeforeBurn_pa, Chaparral_AfterBurn=Chaparral_AfterBurn_pa, Woodland_AfterBurn=Woodland_AfterBurn_pa, Chaparral_AfterControl=Chaparral_AfterControl_pa, Woodland_AfterControl=Woodland_AfterControl_pa)
# plot

upset(data = upsetdata, intersect = c("Woodland_BeforeBurn","Woodland_AfterControl","Woodland_AfterBurn", "Chaparral_BeforeBurn","Chaparral_AfterControl","Chaparral_AfterBurn"), 
  name="vOTU Detection in Viromes by Habitat and Disturbance",
      base_annotations = list('Intersection size (number of vOTUs)'=intersection_size(
        text=list(hjust=-0.05, vjust=0.5, angle = 90))),
      min_size = 10,
      width_ratio = 0.125,
      themes=upset_default_themes(text=element_text(size = 20)),
      sort_sets=FALSE,
      set_sizes=(upset_set_size()+theme(axis.text.x = element_text(angle=90))),
      stripes=upset_stripes(colors=c('#39A96B','#39A96B','#39A96B','goldenrod1','goldenrod1','goldenrod1')))
ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/Upset/Habitat_Disturbance_upset.pdf", width = 300, height = 200, units = "mm", dpi = 500)
```

# Identifying source of vOTUs originally found in other datasets
# REDO THIS BUT WITH vOTUs only found in control and vOTUs only found in burned samples???
```{r}
LNU_contigs <- rownames(lnu_otu)
LNU_contigs <- data.frame(vOTU = LNU_contigs, Source = "LNU")
LNU_contigs <- LNU_contigs %>%
  mutate(ViromeID = str_extract(vOTU, "^[^_]+(?:_[^_]+)*(?=_contig)"))
LNU_habitat <- wildfire_data %>%
  select(ViromeID, Habitat)
LNU_contigs <- LNU_contigs %>%
  left_join(LNU_habitat, by = "ViromeID")
LNU_contigs <- LNU_contigs %>%
  mutate(Habitat = case_when(
    Habitat == "Woodland" ~ "woodland",
    Habitat == "Chaparral" ~ "chaparral"))

Blodgett_contigs <- rownames(lnu_in_Blodgett_otu)
Blodgett_contigs <- data.frame(vOTU = Blodgett_contigs, Source = "Blodgett", Habitat = "mixedconifer_forest")
Blodgett_contigs <- Blodgett_contigs %>%
  mutate(ViromeID = str_extract(vOTU, "^[^_]+(?:_[^_]+)*(?=_contig)"))

Pigeon_contigs <- rownames(lnu_in_PIGEON_otu)
Pigeon_contigs <- data.frame(vOTU=Pigeon_contigs, Source = "PIGEON")
Pigeon_contigs <- Pigeon_contigs %>%
  mutate(Habitat = prefix_to_database(vOTU))
Pigeon_contigs$Habitat <- as.factor(Pigeon_contigs$Habitat)
levels(Pigeon_contigs$Habitat)

NatRsv_contigs <- Pigeon_contigs[Pigeon_contigs$Habitat=="natural_soil",]
pattern <- "natural_reserves_2019_([^_]+_[^_]+_[^_]+)_S"
NatRsv_contigs <- NatRsv_contigs %>%
  mutate(ViromeID = str_extract(vOTU, pattern) %>% 
                      str_replace(pattern, "\\1"))
NatRsv_habitat=read_delim("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/natrsv_habitat.txt", delim = "\t", col_names = TRUE)
NatRsv_contigs <- NatRsv_contigs %>%
  left_join(NatRsv_habitat, by = "ViromeID")

NatRsv_contigs$Habitat.y[NatRsv_contigs$vOTU == "natural_reserves_2019_VIRSorter_QR_1_2_S75_170-circular-cat_2"] <- "chaparral"
NatRsv_contigs$Habitat.y[NatRsv_contigs$vOTU == "natural_reserves_2019_VIRSorter_QR_1_2_S75_84-cat_2"] <- "chaparral"
NatRsv_contigs$Habitat.y[NatRsv_contigs$vOTU == "natural_reserves_2019_VIRSorter_McL_3_1_S30_225-cat_2"] <- "grassland"
NatRsv_contigs$Habitat.y[NatRsv_contigs$vOTU == "natural_reserves_2019_VIRSorter_McL_1_2_S78_59-cat_2"] <- "woodland"

NatRsv_contigs <- NatRsv_contigs %>%
  select(-Habitat.x) %>%
  rename(Habitat = Habitat.y)

Pigeon_contigs <- Pigeon_contigs[Pigeon_contigs$Habitat!="natural_soil",]
Pigeon_contigs <- Pigeon_contigs %>%
  mutate(ViromeID = NA)

all_contigs <- bind_rows(Pigeon_contigs,NatRsv_contigs,Blodgett_contigs,LNU_contigs)
all_contigs$Habitat <- as.factor(all_contigs$Habitat)
levels(all_contigs$Habitat)

original_contigs <- bind_rows(Pigeon_contigs, NatRsv_contigs, Blodgett_contigs)
original_contigs$Habitat <- as.factor(original_contigs$Habitat)
levels(original_contigs$Habitat)

habitat_count <- original_contigs %>%
  count(Habitat)

habitat_count <- habitat_count %>%
  filter(!(Habitat %in% c("chaparral", "woodland")))


custom_colors <- c("agricultural_soil" = "tan3", "bluff" = "slategray3", "chaparral" = "yellowgreen", "grassland" = "limegreen", "lake" = "dodgerblue3", "mixedconifer_forest" = "forestgreen", "peat" = "gray21", "tropical_rainforest" = "springgreen2", "varies" = "tomato", "wetland" = "darkslateblue", "woodland" = "mediumseagreen")


ggplot(habitat_count, aes(x = "", y = n, fill = Habitat)) +
  geom_col(color = "black", linewidth = 0.5) +
  #geom_text(aes(label = paste(Habitat, "-", n)), 
            #position = position_stack(vjust = 0.5)) +
  coord_polar("y", start = 0) +
  #labs(title = "Habitat of Contigs Originally Found in Other Datasets") +
  theme_void() +
  theme(legend.position = "right") +
  scale_fill_manual(values = custom_colors)
  
ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/Habitat_pie.pdf", width = 200, height = 200, units = "mm", dpi = 500)
```

# PIGEON DB + BLODGETT
```{r}
pigeon2 <- read.delim("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/220711_pigeon_headers.txt", header = TRUE)

prefix_to_database <- function(vOTU) {
  case_when(
    str_sub(vOTU, 1, 9) == "almond_CA" ~ "agricultural_soil",
    str_sub(vOTU, 1, 18) == "RR_tom_rhizo_2021_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 8) == "BB_2021_" ~ "wetland",
    str_sub(vOTU, 1, 8) == "RR_2018_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 20) == "Hopland_2021_Santos_" ~ "grassland",
    str_sub(vOTU, 1, 13) == "coutinho_2020" ~ "lake",
    str_sub(vOTU, 1, 8) == "biochar_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 12) == "Sorensen2021" ~ "agricultural_soil",
    str_sub(vOTU, 1, 12) == "citrus_rhizo" ~ "agricultural_soil",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_1_1_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_BB_1_1_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_1_2_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_BB_1_2_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_2_1_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_BB_2_1_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_2_2_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_BB_2_2_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_3_1_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_BB_3_1_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_4_1_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_4_2_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_5_1_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_5_2_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_6_1_" ~ "bluff",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_BB_6_2_" ~ "bluff",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_1_1_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_1_2_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_2_1_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_2_2_" ~ "grassland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_JP_2_2_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_3_1_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_JP_3_1_" ~ "wetland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_JP_3_2_" ~ "wetland",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_JP_3_2_" ~ "wetland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_1_1_" ~ "woodland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_1_2_" ~ "woodland",
    str_sub(vOTU, 1, 40) == "natural_reserves_2019_VIRSorter_McL_1_2_" ~ "woodland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_3_1_" ~ "grassland",
    str_sub(vOTU, 1, 40) == "natural_reserves_2019_VIRSorter_McL_3_1_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_3_2_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_5_1_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_5_2_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_6_1_" ~ "chaparral",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_6_2_" ~ "chaparral",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_McL_7_1_" ~ "grassland",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_QR_1_1_" ~ "chaparral",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_QR_1_2_" ~ "chaparral",
    str_sub(vOTU, 1, 39) == "natural_reserves_2019_VIRSorter_QR_1_2_" ~ "chaparral",
    str_sub(vOTU, 1, 29) == "natural_reserves_2019_QR_2_2_" ~ "woodland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_SCC_1_1_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_SCC_1_2_" ~ "grassland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_SCC_2_1_" ~ "woodland",
    str_sub(vOTU, 1, 30) == "natural_reserves_2019_SCC_2_2_" ~ "woodland",
    str_sub(vOTU, 1, 3) == "EV_" ~ "varies",
    str_sub(vOTU, 1, 11) == "RR_6_8_frac" ~ "tropical_rainforest",
    str_sub(vOTU, 1, 7) == "SPRUCE_" ~ "peat",
    str_sub(vOTU, 1, 11) == "1_RHIZ_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 11) == "2_RHIZ_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 11) == "3_RHIZ_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 11) == "4_RHIZ_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 12) == "_4_RHIZ_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 9) == "1_BU_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 10) == "_1_BU_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 9) == "2_BU_ALM_" ~ "agricultural_soil",
    str_sub(vOTU, 1, 4) == "GOV_" ~ "ocean", 
    str_sub(vOTU, 1, 13) == "coutinho_2020" ~ "lake",
    str_sub(vOTU, 1, 11) == "myriam_2020" ~ "lake",
    str_sub(vOTU, 1, 8) == "vik_2020" ~ "ocean",
    str_sub(vOTU, 1, 9) == "roux2019_" ~ "peat",
    str_sub(vOTU, 1, 7) == "ICE_SIP" ~ "peat",
    str_sub(vOTU, 1, 12) == "emerson2018_" ~ "peat",
    str_sub(vOTU, 1, 15) == "tomato_rhizo_GH" ~ "agricultural_soil",
    str_sub(vOTU, 1, 4) == "GRE_" ~ "tropical_rainforest",
    str_sub(vOTU, 1, 10) == "trubl2018_" ~ "peat",
    str_sub(vOTU, 1, 10) == "trubl2019_" ~ "peat",
    str_sub(vOTU, 1, 11) == "borton2018_" ~ "wetland",
    str_sub(vOTU, 1, 7) == "li_2021" ~ "ocean",
    TRUE ~ "unknown" # Default value if the prefix does not match any known database
  )
}

pigeon2 <- pigeon2 %>%
  mutate(Habitat = prefix_to_database(vOTU))

# earth's virome
ev <- read.delim("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/origin_EV.txt", header = TRUE)
ev <- ev %>%
  rename(Habitat = Ecosystem) %>%
  select(-origin)
ev$org_header <- as.character(ev$org_header)
pigeon2_ev <- subset(pigeon2, Habitat=="varies")
pigeon2_ev <- pigeon2_ev %>%
  # Extract the org_header part from vOTU
  mutate(org_header = sub("EV_(\\d+).*", "\\1", vOTU)) %>%
  # Left join with the second dataframe on the org_header
  left_join(ev, by = "org_header") %>%
  # Replace the old Habitat with the new Habitat from the second dataframe
  mutate(Habitat = Habitat.y) %>%
  # Select only the necessary columns
  select(vOTU, Habitat)

pigeon2 <- pigeon2 %>%
  left_join(pigeon2_ev, by = "vOTU", suffix = c(".all", ".subset")) %>%
  mutate(Habitat = ifelse(is.na(Habitat.subset), Habitat.all, Habitat.subset)) %>%
  select(vOTU, Habitat)

blodgett <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/blodgett_contigs_habitat.RDS")
pigeon3 <- rbind(pigeon2, blodgett)

pigeon3$Habitat <- as.factor(pigeon3$Habitat)
levels(pigeon3$Habitat)
pigeon3 <- pigeon3 %>%
  mutate(NewHabitat = case_when(
    Habitat == "agricultural_soil" ~ "soil",
    Habitat == "Ascidians" ~ "host-associated", 
    Habitat == "Bacteria" ~ "host-associated", 
    Habitat == "bluff" ~ "soil",
    Habitat == "chaparral" ~ "soil", 
    Habitat == "Composting" ~ "engineered", 
    Habitat == "Continuous culture" ~ "host-associated", 
    Habitat == "Dairy products" ~ "host-associated", 
    Habitat == "Deep subsurface" ~ "terrestrial (non-soil)",
    Habitat == "Defined media" ~ "engineered",
    Habitat == "Digestive system" ~ "host-associated",
    Habitat == "Forest" ~ "soil",
    Habitat == "Forest_Burned" ~ "soil",
    Habitat == "Forest_Disturbed" ~ "soil",
    Habitat == "Forest_Heated" ~ "soil",
    Habitat == "Forest_Heated30ºC" ~ "soil",
    Habitat == "Forest_Heated60ºC" ~ "soil",
    Habitat == "Forest_Heated90ºC" ~ "soil",
    Habitat == "Forest_Undisturbed" ~ "soil",
    Habitat == "Freshwater" ~ "freshwater",
    Habitat == "grassland" ~ "soil",
    Habitat == "Hydrocarbon" ~ "engineered",
    Habitat == "Industrial wastewater" ~ "water (other)",
    Habitat == "Integument" ~ "host-associated",
    Habitat == "Intracellular endosymbionts" ~ "host-associated",
    Habitat == "lake" ~ "freshwater",
    Habitat == "Marine" ~ "ocean",
    Habitat == "Microbial enhanced oil recovery" ~ "engineered",
    Habitat == "Microbial solubilization of coal" ~ "engineered",
    Habitat == "Mixed alcohol bioreactor" ~ "engineered",
    Habitat == "Non-marine Saline and Alkaline" ~ "water (other)",
    Habitat == "Nutrient removal" ~ "engineered",
    Habitat == "ocean" ~ "ocean",
    Habitat == "Oil reservoir" ~ "terrestrial (non-soil)",
    Habitat == "Outdoor Air" ~ "air",
    Habitat == "peat" ~ "soil",
    Habitat == "Phylloplane" ~ "plant-associated",
    Habitat == "Reproductive system" ~ "host-associated",
    Habitat == "Respiratory system" ~ "host-associated",
    Habitat == "Rhizoplane" ~ "plant-associated",
    Habitat == "Skin" ~ "host-associated",
    Habitat == "Soil" ~ "soil",
    Habitat == "Symbiotic fungal gardens and galleries" ~ "host-associated",
    Habitat == "Terephthalate" ~ "engineered",
    Habitat == "Tetrachloroethylene and derivatives" ~ "engineered",
    Habitat == "Thermal springs" ~ "water (other)",
    Habitat == "tropical_rainforest" ~ "soil",
    Habitat == "Unclassified" ~ "unclassified",
    Habitat == "unknown" ~ "unclassified",
    Habitat == "varies" ~ "unclassified",
    Habitat == "wetland" ~ "soil",
    Habitat == "woodland" ~ "soil"
  ))

habitat_count <- pigeon3 %>%
  count(NewHabitat)

habitat_count <- habitat_count %>%
  filter(!(NewHabitat %in% c("chaparral", "woodland")))


ggplot(habitat_count, aes(x = "", y = n, fill = NewHabitat)) +
  geom_col(color = "black", linewidth = 0.5) +
  #geom_text(aes(label = paste(Habitat, "-", n)), 
            #position = position_stack(vjust = 0.5)) +
  coord_polar("y", start = 0) +
  #labs(title = "Habitat of Contigs Originally Found in Other Datasets") +
  theme_void() +
  theme(legend.position = "right") #+
  #scale_fill_manual(values = custom_colors)

ggplot(habitat_count, aes(x = "", y = n, fill = NewHabitat)) +
  geom_bar(stat = "identity", width = 1) +
  coord_flip() +
  theme_minimal() +
  theme(axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      panel.grid = element_blank(),
      plot.title = element_text(hjust = 0.5))
```



# identifying how many vOTUs clustered with vOTUs from original dataset
```{r}
# these are all the contigs that were found in other datasets
Pb_contigs <- bind_rows(Pigeon_contigs,NatRsv_contigs,Blodgett_contigs)

# I need to remove the chaparral and woodland contigs, because that is redundant
Pb_contigs <- Pb_contigs %>%
  filter(!(Habitat %in% c("chaparral", "woodland")))

# total number of NEW contigs - 1,644
length(unique(Pb_contigs$vOTU))

# these are all the contigs that were found the LNU dataset after clustering with these NEW contigs
LNU_Pb_contigs <- rownames(lnu_Pb_otu)
LNU_Pb_contigs <- data.frame(vOTU = LNU_Pb_contigs)

# these are the contigs that are found as they are originally named in the Blodgett/PIGEON database: 904 contigs
merge_contigs <- merge(LNU_Pb_contigs, Pb_contigs, by = "vOTU")

# these are the contigs that were found in Blodgett/PIGEON database but maybe got renamed because it clustered under another contig from the LNU study which was a better representative: 740 contigs
renamed_contigs <- anti_join(Pb_contigs, merge_contigs, by = "vOTU")
vOTU <- renamed_contigs$vOTU
writeLines(as.character(vOTU), "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/renamed_contigs.txt")

cdhit_clusters <- read.csv("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/clustered_Pbl.fna.csv", header = TRUE, sep = ",")


### THIS DIDN'T WORK....???? I DON'T EVEN KNOW WHAT I'm TRYING TO DO HERE...
# this is a dataframe showing what those Blodgett/PIGEON contigs got renamed to OR what the original dataset contigs might have gotten renamed to under this analysis
cluster_contig_names <- merge(renamed_contigs, cdhit_clusters, by.x = "vOTU", by.y = "vOTU", all.x = TRUE)
unique(cluster_contig_names$OTU) #121 original contigs
unique(cluster_contig_names$Renamed_OTU) # shrank to 105 contigs
```


# Host Prediction - data prep
```{r}
# Prep file in excel (text to column wizard under data tab to separate out taxonomy)
iphop.genus <- read.csv("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/input data/all_Host_prediction_to_genus_m90.csv")
iphop.filter <- iphop.genus %>%
  group_by(Virus) %>%
  filter(Confidence.score == max(Confidence.score)) %>%
  ungroup()
colnames(iphop.filter)[colnames(iphop.filter) == "Virus"] <- "vOTU"

# to determine if there are duplicates
length(unique(iphop.filter$vOTU))
# remove exact duplicates
iphop.uniq <- iphop.filter %>%
  distinct()
# to investigate the other duplicates use this and keep repeating until all duplicates are taken care of
duplicates <- iphop.uniq %>% filter(duplicated(vOTU) | duplicated(vOTU, fromLast = TRUE))
# remove duplicates that are the same except for different HostGenus and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostGenus = ifelse(n_distinct(HostGenus) > 1, "mixed", HostGenus)) %>%
  ungroup()
# remove duplicates that are the same except for different HostFamily and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostFamily = ifelse(n_distinct(HostFamily) > 1, "mixed", HostFamily)) %>%
  ungroup()
# remove duplicates that are the same except for different HostOrder and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostOrder = ifelse(n_distinct(HostOrder) > 1, "mixed", HostOrder)) %>%
  ungroup()
# remove duplicates that are the same except for different HostClass and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostClass = ifelse(n_distinct(HostClass) > 1, "mixed", HostClass)) %>%
  ungroup()
# remove duplicates that are the same except for different HostPhylum and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostPhylum = ifelse(n_distinct(HostPhylum) > 1, "mixed", HostPhylum)) %>%
  ungroup()
# remove duplicates that are the same except for different HostDomain and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(HostDomain = ifelse(n_distinct(HostDomain) > 1, "mixed", HostDomain)) %>%
  ungroup()
# remove duplicates that are the same except for different List.of.methods and change that value to "mixed"
iphop.uniq <- iphop.uniq %>%
  group_by(vOTU) %>%
  mutate(List.of.methods = ifelse(n_distinct(List.of.methods) > 1, "mixed", List.of.methods)) %>%
  ungroup()
# remove exact duplicates
iphop.uniq <- iphop.uniq %>%
  distinct()

# save dataframe for all information of vOTU host prediction
iphop.LNU <- iphop.uniq

#create dataframe with just OTU and phylum from iphop
iphop.phylum <- iphop.uniq[, c("vOTU", "HostPhylum")]
saveRDS(iphop.phylum, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/iphop_phylum.RDS")
iphop.phylum <- readRDS("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/iphop_phylum.RDS")
```
# host prediction - whole dataset (only the LNU clustered with itself, not with PIGEON or blodgett contigs)
## I WILL NEED TO REDO THIS ONCE I GET THE FILES FINISHED IN FARM!
```{r}
# name row.names of otu.rel
otu.rel.otu <- otu.rel %>%
  rownames_to_column(var = "vOTU")
otu.rel.phylum <- merge(iphop.phylum, otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
otu.rel.phylum <- otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
otu.rel.phylum <- otu.rel.phylum %>% select(-vOTU) 
otu.phylum.long <- pivot_longer(otu.rel.phylum, cols=2:47, names_to = "ViromeID", values_to = "RelAbd")
saveRDS(otu.phylum.long, "C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/rds/otu.phylum.long.rds")
otu.phylum.stack <- group_by(otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
otu.phylum.stack <- otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

# Prep data frame for plotting
otu.phylum.map <- merge(otu.phylum.stack, wildfire_data, by="ViromeID")
otu.phylum.map <- otu.phylum.map[otu.phylum.map$NewHostPhylum != "Unknown", ]

# Plot
hostphylum <- ggplot(otu.phylum.map, aes(x=ViromeID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "LNU vOTU Host Prediction by Sample")+
  geom_bar(stat="identity")+
  #scale_fill_manual(values=collapsed_phylum_colors) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  facet_wrap(~ Treatment)
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/allhostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```
# host prediction - Only Chaparral (only the LNU clustered with itself, not with PIGEON or blodgett contigs)
```{r}
# name row.names of otu.rel
ch.otu.rel.otu <- ch.otu.rel %>%
  rownames_to_column(var = "vOTU")
ch.otu.rel.phylum <- merge(iphop.phylum, ch.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
ch.otu.rel.phylum <- ch.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
ch.otu.rel.phylum <- ch.otu.rel.phylum %>% select(-vOTU) 
ch.otu.phylum.long <- pivot_longer(ch.otu.rel.phylum, cols=2:24, names_to = "ViromeID", values_to = "RelAbd")
ch.otu.phylum.stack <- group_by(ch.otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
ch.otu.phylum.stack <- ch.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

iphop_wildfire_data <- wildfire_data %>%
  mutate(Time_ID = paste(TimePoint, "-", SubPlot)) %>%
  arrange(Time_ID)

# Prep data frame for plotting
ch.otu.phylum.map <- merge(ch.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
ch.otu.phylum.map <- ch.otu.phylum.map[ch.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(ch.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(ch.otu.phylum.map, aes(x=Time_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "Chaparral - LNU vOTU Host Prediction by Sample")+
  annotate('rect', xmin = 0, xmax = 4.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  annotate('rect', xmin = 11.5, xmax = 15.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(4.5, 7.5, 19.5), linetype = "solid", color = "black", linewidth = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/chaparral_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```
# Host Prediction - Chaparral, Burned
```{r}
# name row.names of otu.rel
f.ch.otu.rel.otu <- f.ch.otu.rel %>%
  rownames_to_column(var = "vOTU")
f.ch.otu.rel.phylum <- merge(iphop.phylum, f.ch.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
f.ch.otu.rel.phylum <- f.ch.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
f.ch.otu.rel.phylum <- f.ch.otu.rel.phylum %>% select(-vOTU) 
f.ch.otu.phylum.long <- pivot_longer(f.ch.otu.rel.phylum, cols=2:16, names_to = "ViromeID", values_to = "RelAbd")
f.ch.otu.phylum.stack <- group_by(f.ch.otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
f.ch.otu.phylum.stack <- f.ch.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

iphop_wildfire_data <- wildfire_data %>%
  mutate(Time_ID = paste(TimePoint, "-", SubPlot)) %>%
  arrange(Time_ID)

# Prep data frame for plotting
f.ch.otu.phylum.map <- merge(f.ch.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
f.ch.otu.phylum.map <- f.ch.otu.phylum.map[f.ch.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(f.ch.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(f.ch.otu.phylum.map, aes(x=Time_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "Chaparral - LNU vOTU Host Prediction by Sample")+
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(3.5, 11.5), linetype = "solid", color = "black", linewidth = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/chaparral_burned_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

# Host Prediction - Chaparral, Control vs. Burn (T3)
```{r}
# name row.names of otu.rel
T3.ch.otu.rel.otu <- T3.ch.otu.rel %>%
  rownames_to_column(var = "vOTU")
T3.ch.otu.rel.phylum <- merge(iphop.phylum, T3.ch.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
T3.ch.otu.rel.phylum <- T3.ch.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
T3.ch.otu.rel.phylum <- T3.ch.otu.rel.phylum %>% select(-vOTU) 
T3.ch.otu.phylum.long <- pivot_longer(T3.ch.otu.rel.phylum, cols=2:13, names_to = "ViromeID", values_to = "RelAbd")
T3.ch.otu.phylum.stack <- group_by(T3.ch.otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
T3.ch.otu.phylum.stack <- T3.ch.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

iphop_wildfire_data <- wildfire_data %>%
  mutate(Time_ID = paste(TimePoint, "-", SubPlot)) %>%
  arrange(Time_ID)
iphop_wildfire_data <- iphop_wildfire_data %>%
  mutate(Treatment_ID = paste(Treatment, "-", SubPlot)) %>%
  arrange(Treatment_ID)

# Prep data frame for plotting
T3.ch.otu.phylum.map <- merge(T3.ch.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
T3.ch.otu.phylum.map <- T3.ch.otu.phylum.map[T3.ch.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(T3.ch.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(T3.ch.otu.phylum.map, aes(x=Treatment_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "T3, Chaparral - LNU vOTU Host Prediction by Sample")+
  annotate('rect', xmin = -Inf, xmax = 4.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  scale_x_discrete(labels = T3.ch.map$TimePoint_ID) +
  geom_vline(xintercept = c(4.5), linetype = "solid", color = "black", linewidth = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/chaparral_T3_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

# Host Prediction Stats - chaparral
```{r}
ch.host.stats <- ch.otu.phylum.map

acido_ch <- ch.host.stats %>%
  filter(HostPhylum == "Acidobacteriota" & TimePoint != "T0")
actino_ch <- ch.host.stats %>%
  filter(HostPhylum == "Actinobacteriota" & TimePoint != "T0")
bact_ch <- ch.host.stats %>%
  filter(HostPhylum == "Bacteroidota" & TimePoint != "T0")
firm_ch <- ch.host.stats %>%
  filter(HostPhylum == "Firmicutes" & TimePoint != "T0")
gemma_ch <- ch.host.stats %>%
  filter(HostPhylum == "Gemmatimonadota" & TimePoint != "T0")
myxo_ch <- ch.host.stats %>%
  filter(HostPhylum == "Myxococcota" & TimePoint != "T0")
nitro_ch <- ch.host.stats %>%
  filter(HostPhylum == "Nitrospirota" & TimePoint != "T0")
proteo_ch <- ch.host.stats %>%
  filter(HostPhylum == "Proteobacteria" & TimePoint != "T0")

kruskal.test(RelAbd ~ Treatment, acido_ch)
kruskal.test(RelAbd ~ Treatment, actino_ch)
kruskal.test(RelAbd ~ Treatment, bact_ch)
kruskal.test(RelAbd ~ Treatment, firm_ch)
kruskal.test(RelAbd ~ Treatment, gemma_ch)
kruskal.test(RelAbd ~ Treatment, myxo_ch)
kruskal.test(RelAbd ~ Treatment, nitro_ch)
kruskal.test(RelAbd ~ Treatment, proteo_ch)

```

# host prediction - Only Woodland (only the LNU clustered with itself, not with PIGEON or blodgett contigs)
```{r}
# name row.names of otu.rel
wo.otu.rel.otu <- wo.otu.rel %>%
  rownames_to_column(var = "vOTU")
wo.otu.rel.phylum <- merge(iphop.phylum, wo.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
wo.otu.rel.phylum <- wo.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
wo.otu.rel.phylum <- wo.otu.rel.phylum %>% select(-vOTU) 
wo.otu.phylum.long <- pivot_longer(wo.otu.rel.phylum, cols=2:23, names_to = "ViromeID", values_to = "RelAbd")
wo.otu.phylum.stack <- group_by(wo.otu.phylum.long, HostPhylum, ViromeID) %>%
  summarize(RelAbd=sum(RelAbd))
wo.otu.phylum.stack <- wo.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

# Prep data frame for plotting
wo.otu.phylum.map <- merge(wo.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
wo.otu.phylum.map <- wo.otu.phylum.map[wo.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(wo.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(wo.otu.phylum.map, aes(x=Time_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "Woodland - LNU vOTU Host Prediction by Sample")+
  annotate('rect', xmin = 0, xmax = 3.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  annotate('rect', xmin = 11.5, xmax = 15.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(3.5, 7.5, 19.5), linetype = "solid", color = "black", size = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/woodland_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```

```{r}
wo.host.stats <- wo.otu.phylum.map


actino_wo <- wo.host.stats %>%
  filter(HostPhylum == "Actinobacteriota" & TimePoint != "T0")
bact_wo <- wo.host.stats %>%
  filter(HostPhylum == "Bacteroidota" & TimePoint != "T0")
cyan_wo <- wo.host.stats %>%
  filter(HostPhylum == "Cyanobacteria" & TimePoint != "T0")
firm_wo <- wo.host.stats %>%
  filter(HostPhylum == "Firmicutes" & TimePoint != "T0")
gemma_wo <- wo.host.stats %>%
  filter(HostPhylum == "Gemmatimonadota" & TimePoint != "T0")
myxo_wo <- wo.host.stats %>%
  filter(HostPhylum == "Myxococcota" & TimePoint != "T0")
nitro_wo <- wo.host.stats %>%
  filter(HostPhylum == "Nitrospirota" & TimePoint != "T0")
proteo_wo <- wo.host.stats %>%
  filter(HostPhylum == "Proteobacteria" & TimePoint != "T0")

kruskal.test(RelAbd ~ Treatment, actino_wo)
kruskal.test(RelAbd ~ Treatment, bact_wo)
kruskal.test(RelAbd ~ Treatment, cyan_wo)
kruskal.test(RelAbd ~ Treatment, firm_wo)
kruskal.test(RelAbd ~ Treatment, gemma_wo)
kruskal.test(RelAbd ~ Treatment, myxo_wo)
kruskal.test(RelAbd ~ Treatment, nitro_wo)
kruskal.test(RelAbd ~ Treatment, proteo_wo)
```


# Host Prediction - Woodland, Burned
```{r}
# name row.names of otu.rel
f.wo.otu.rel.otu <- f.wo.otu.rel %>%
  rownames_to_column(var = "vOTU")
f.wo.otu.rel.phylum <- merge(iphop.phylum, f.wo.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
f.wo.otu.rel.phylum <- f.wo.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
f.wo.otu.rel.phylum <- f.wo.otu.rel.phylum %>% select(-vOTU) 
f.wo.otu.phylum.long <- pivot_longer(f.wo.otu.rel.phylum, cols=2:17, names_to = "ViromeID", values_to = "RelAbd")
f.wo.otu.phylum.stack <- group_by(f.wo.otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
f.wo.otu.phylum.stack <- f.wo.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

iphop_wildfire_data <- wildfire_data %>%
  mutate(Time_ID = paste(TimePoint, "-", SubPlot)) %>%
  arrange(Time_ID)

# Prep data frame for plotting
f.wo.otu.phylum.map <- merge(f.wo.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
f.wo.otu.phylum.map <- f.wo.otu.phylum.map[f.wo.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(f.wo.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(f.wo.otu.phylum.map, aes(x=Time_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "Woodland - LNU vOTU Host Prediction by Sample")+
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(4.5, 12.5), linetype = "solid", color = "black", linewidth = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/woodland_burned_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```
# Host Prediction - Woodland, Control vs. Burn (T3)
```{r}
# name row.names of otu.rel
T3.wo.otu.rel.otu <- T3.wo.otu.rel %>%
  rownames_to_column(var = "vOTU")
T3.wo.otu.rel.phylum <- merge(iphop.phylum, T3.wo.otu.rel.otu, by = "vOTU", all.y = TRUE)

# replace NA Host Phylum with "unknown"
T3.wo.otu.rel.phylum <- T3.wo.otu.rel.phylum %>% mutate(HostPhylum = ifelse(is.na(HostPhylum), "Unknown", HostPhylum))
# remove OTU column
T3.wo.otu.rel.phylum <- T3.wo.otu.rel.phylum %>% select(-vOTU) 
T3.wo.otu.phylum.long <- pivot_longer(T3.wo.otu.rel.phylum, cols=2:13, names_to = "ViromeID", values_to = "RelAbd")
T3.wo.otu.phylum.stack <- group_by(T3.wo.otu.phylum.long, HostPhylum, ViromeID) %>%
  dplyr::summarize(RelAbd=sum(RelAbd))
T3.wo.otu.phylum.stack <- T3.wo.otu.phylum.stack %>%
  group_by(HostPhylum) %>%
  mutate(NewHostPhylum = ifelse(all(RelAbd < 0.001), 'Other', HostPhylum)) %>%
  ungroup()

iphop_wildfire_data <- wildfire_data %>%
  mutate(Time_ID = paste(TimePoint, "-", SubPlot)) %>%
  arrange(Time_ID)
iphop_wildfire_data <- iphop_wildfire_data %>%
  mutate(Treatment_ID = paste(Treatment, "-", SubPlot)) %>%
  arrange(Treatment_ID)

# Prep data frame for plotting
T3.wo.otu.phylum.map <- merge(T3.wo.otu.phylum.stack, iphop_wildfire_data, by="ViromeID")
T3.wo.otu.phylum.map <- T3.wo.otu.phylum.map[T3.wo.otu.phylum.map$NewHostPhylum != "Unknown", ]

unique(T3.wo.otu.phylum.map$NewHostPhylum)

# Plot
hostphylum <- ggplot(T3.wo.otu.phylum.map, aes(x=Treatment_ID, y=RelAbd, fill=NewHostPhylum))+
    labs(x="Sample ID", 
       y ="Relative Abundance",
       title = "T3, Woodland - LNU vOTU Host Prediction by Sample")+
  annotate('rect', xmin = -Inf, xmax = 4.5, ymin = -Inf, ymax = Inf, fill = 'lightgray', alpha = 0.5) +
  geom_bar(stat="identity")+
  scale_fill_manual(values=collapsed_phylum_colors) +
  geom_vline(xintercept = c(4.5), linetype = "solid", color = "black", linewidth = 0.5)+
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))
hostphylum <- ggsave("C:/Users/segeo/Box Sync/EmersonLab/Research/Ch3Wildfire/R_Figures/pdf/StackedBar/virome/woodland_T3_hostLNU_phylum.pdf", width = 200, height = 150, units = "mm", dpi = 500)
```